# ros-z Go Binding Build System
# Run from anywhere: just -f crates/ros-z-go/justfile <target>
# Or: cd crates/ros-z-go && just <target>

# Workspace root (two levels up from crates/ros-z-go/)
workspace_root := justfile_directory() / "../.."

# Configuration - override with `just --set rust_target_dir ...`
rust_target_dir := "target/release"
go_gen_dir := workspace_root / "crates/ros-z-go/generated"
ros_distro := env("ROS_DISTRO", "humble")
ros_path := env("ROS_PATH", "/opt/ros/" + ros_distro + "/share")

# CGO linker flags pointing to the Rust static library
cgo_ldflags := "-L" + workspace_root + "/" + rust_target_dir

# Default recipe: build everything
default: build-rust build-go

# Show help
help:
    @echo "ros-z Go Binding Build System"
    @echo "Run from anywhere: just -f crates/ros-z-go/justfile <target>"
    @echo ""
    @echo "Build:"
    @echo "  default          - Build everything (build-rust + build-go)"
    @echo "  build-rust       - Build Rust library with FFI support"
    @echo "  build-go         - Build Go library (requires build-rust)"
    @echo "  build-go-codegen - Build the Go code generator tool"
    @echo "  build-go-examples - Build all example binaries"
    @echo "  codegen          - Generate message types from ROS IDL (needs ROS 2)"
    @echo "  codegen-bundled  - Generate common types from bundled IDL (no ROS 2 needed)"
    @echo ""
    @echo "Test (tiered):"
    @echo "  test             - Run all tests (Rust + Go pure + Go FFI)"
    @echo "  test-rust        - Run Rust tests only"
    @echo "  test-go-pure     - Pure Go tests (no FFI, no external deps)"
    @echo "  test-go-ffi      - Go FFI unit tests (requires build-rust)"
    @echo "  test-go          - All Go tests (pure + FFI + examples build)"
    @echo ""
    @echo "Dev:"
    @echo "  quickstart       - Full setup: codegen-bundled + build-rust + verify"
    @echo "  run-example name - Build and run a named example (e.g. publisher)"
    @echo "  demo             - Run publisher + subscriber in parallel"
    @echo "  verify           - Verify installation (library, header, generated msgs)"
    @echo ""
    @echo "Maintenance:"
    @echo "  clean            - Clean all build artifacts"
    @echo ""
    @echo "Configuration (environment variables):"
    @echo "  ROS_PATH    - Path to ROS 2 share directory (default: /opt/ros/{{ros_distro}}/share)"
    @echo "  ROS_DISTRO  - ROS 2 distribution name (default: humble)"
    @echo ""
    @echo "Test tiers:"
    @echo "  pure        - No dependencies, just Go (testdata serialization, codegen)"
    @echo "  ffi         - Requires libros_z.a (rosz package unit tests)"

# --- Build recipes ---

# Build Rust library with FFI (cbindgen runs automatically via build.rs)
build-rust:
    @echo "Building Rust library with FFI support..."
    cd {{workspace_root}} && cargo build --release --features ffi

# Build Go library
build-go: build-rust
    @echo "Building Go library..."
    CGO_LDFLAGS="{{cgo_ldflags}}" go build ./rosz/...

# Build Go code generator
build-go-codegen:
    @echo "Building Go code generator..."
    cd {{workspace_root}}/crates/ros-z-codegen-go && go build -o ros-z-codegen-go .

# Build all example binaries (publisher, subscriber, subscriber_channel)
build-go-examples: build-rust codegen-bundled
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p "{{workspace_root}}/_tmp"
    for example in publisher subscriber subscriber_channel; do
        echo "Building example: $example"
        cd "{{workspace_root}}/crates/ros-z-go/examples/$example"
        CGO_LDFLAGS="{{cgo_ldflags}}" go build -o "{{workspace_root}}/_tmp/go-example-$example" .
    done
    echo "All examples built successfully."

# Generate message types from a full ROS 2 installation
codegen: build-go-codegen
    @echo "Generating message types from {{ros_path}}..."
    mkdir -p {{go_gen_dir}}
    cd {{workspace_root}}/crates/ros-z-codegen && cargo run --release -- \
        --ros-path {{ros_path}} \
        --rust-out ../ros-z-msgs/src/generated \
        --json-out {{go_gen_dir}}/manifest.json
    {{workspace_root}}/crates/ros-z-codegen-go/ros-z-codegen-go \
        -input {{go_gen_dir}}/manifest.json \
        -output {{go_gen_dir}}
    @echo "Code generation complete."

# Generate common message types from bundled IDL (no ROS 2 required)
# Covers std_msgs, geometry_msgs
codegen-bundled:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Generating common message types from bundled IDL..."
    mkdir -p "{{workspace_root}}/_tmp"

    # Step 1: export JSON manifest from bundled IDL assets
    cargo run -p ros-z-codegen --bin export_json -- \
        --assets "{{workspace_root}}/crates/ros-z-codegen/assets/jazzy" \
        --output "{{workspace_root}}/_tmp/codegen-manifest.json" \
        --packages "builtin_interfaces,std_msgs,geometry_msgs"

    # Step 2: generate Go files from the manifest
    mkdir -p "{{go_gen_dir}}"
    cd "{{workspace_root}}/crates/ros-z-codegen-go" && go run . \
        -input "{{workspace_root}}/_tmp/codegen-manifest.json" \
        -output "{{go_gen_dir}}" \
        -prefix "github.com/ZettaScaleLabs/ros-z/crates/ros-z-go"

    echo "Generated messages in crates/ros-z-go/generated/"

# --- Test recipes (tiered) ---

# Run all non-integration tests
test: test-rust test-go

# Run Rust tests
test-rust:
    @echo "=== Rust tests ==="
    cd {{workspace_root}} && cargo test

# Pure Go tests: no FFI, no external dependencies
# Covers: testdata serialization, codegen unit tests
test-go-pure:
    @echo "=== Go pure tests (no FFI) ==="
    @echo "--- codegen tests ---"
    cd {{workspace_root}}/crates/ros-z-codegen-go && go test -v ./...
    @echo "--- testdata serialization tests ---"
    cd {{justfile_directory()}}/testdata && go test -v .

# Go FFI unit tests: requires libros_z.a
# Covers: rosz package (types, callback registry, pub/sub interfaces)
test-go-ffi: build-rust
    @echo "=== Go FFI unit tests ==="
    CGO_LDFLAGS="{{cgo_ldflags}}" go test -v ./rosz/...

# All Go tests: pure + FFI + examples build check
test-go: test-go-pure test-go-ffi build-go-examples

# --- Dev recipes ---

# Quick start: generate bundled types, build Rust library, verify
quickstart: codegen-bundled
    #!/usr/bin/env bash
    echo "Quick Start Setup"
    echo "================="
    echo ""
    echo "1. Building Rust FFI library..."
    just -f "{{justfile()}}" build-rust
    echo ""
    echo "2. Message types generated"
    echo ""
    echo "3. Verifying installation..."
    just -f "{{justfile()}}" verify
    echo ""
    echo "Setup complete! Try an example:"
    echo ""
    echo "   just -f crates/ros-z-go/justfile run-example publisher"
    echo "   just -f crates/ros-z-go/justfile demo"
    echo ""

# Run any example by name (handles CGO_LDFLAGS automatically)
# Builds to _tmp/ so no binaries are left in the source tree.
# Usage: just -f crates/ros-z-go/justfile run-example publisher
run-example name:
    #!/usr/bin/env bash
    set -e
    example_path="{{workspace_root}}/crates/ros-z-go/examples/{{name}}"
    bin="{{workspace_root}}/_tmp/go-example-$(echo "{{name}}" | tr '/' '-')"

    mkdir -p "{{workspace_root}}/_tmp"
    echo "Building {{name}} -> _tmp/..."
    cd "$example_path"
    CGO_LDFLAGS="-L{{workspace_root}}/{{rust_target_dir}} -lros_z" go build -o "$bin" .

    echo "Running {{name}}..."
    exec "$bin"

# Run publisher and subscriber in parallel (Ctrl+C to stop both)
demo:
    #!/usr/bin/env bash
    echo "Starting publisher/subscriber demo..."
    echo "Press Ctrl+C to stop both"
    trap 'kill 0' SIGINT

    cd {{workspace_root}}/crates/ros-z-go/examples
    (cd subscriber && CGO_LDFLAGS="-L{{workspace_root}}/{{rust_target_dir}}" go run . 2>&1 | sed 's/^/[SUB] /') &
    sleep 1
    (cd publisher && CGO_LDFLAGS="-L{{workspace_root}}/{{rust_target_dir}}" go run . 2>&1 | sed 's/^/[PUB] /')
    wait

# Verify installation: check library, FFI header, generated messages
verify:
    #!/usr/bin/env bash
    echo "Verifying ros-z-go installation..."
    echo ""

    if [ -f "{{workspace_root}}/{{rust_target_dir}}/libros_z.a" ]; then
        echo "  libros_z.a found"
    else
        echo "  libros_z.a missing — run 'just -f crates/ros-z-go/justfile build-rust'"
        exit 1
    fi

    if [ -f "{{workspace_root}}/crates/ros-z-go/rosz/ros_z_ffi.h" ]; then
        echo "  ros_z_ffi.h found"
    else
        echo "  ros_z_ffi.h missing — rebuild with 'just -f crates/ros-z-go/justfile build-rust'"
        exit 1
    fi

    if [ -d "{{workspace_root}}/crates/ros-z-go/generated" ]; then
        count=$(find "{{workspace_root}}/crates/ros-z-go/generated" -name "*.go" | wc -l)
        echo "  Generated messages ($count files)"
    else
        echo "  No generated messages — run 'just -f crates/ros-z-go/justfile codegen-bundled'"
    fi

    echo ""
    echo "Installation OK"

# --- Maintenance ---

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    cd {{workspace_root}} && cargo clean
    go clean 2>/dev/null || true
    cd {{workspace_root}}/crates/ros-z-codegen-go && go clean 2>/dev/null || true
    rm -rf {{go_gen_dir}}
    rm -f {{workspace_root}}/crates/ros-z-codegen-go/ros-z-codegen-go
    @echo "Clean complete."
