name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  formatting:
    name: Check Formatting
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Check formatting
        run: nix build .#checks.x86_64-linux.pre-commit-check -L

  no-ros:
    name: ROS-independent Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#pureRust-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Clippy (default workspace)
        run: |
          source /tmp/nix-dev-env.sh
          cargo clippy --lib --bins --tests -- -D warnings

      - name: Check default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo check

      - name: Build default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo build

      - name: Build examples without ROS dependencies
        run: |
          source /tmp/nix-dev-env.sh
          cargo build --examples

      - name: Run tests
        run: |
          source /tmp/nix-dev-env.sh
          cargo nextest run

      - name: Check ros-z-msgs with bundled messages (no ROS required)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs
          cargo check -p ros-z-msgs --features bundled_msgs
          cargo check -p ros-z-msgs --features common_interfaces

      - name: Build ros-z-msgs with individual bundled packages
        run: |
          source /tmp/nix-dev-env.sh
          cargo build -p ros-z-msgs --no-default-features --features std_msgs
          cargo build -p ros-z-msgs --no-default-features --features geometry_msgs
          cargo build -p ros-z-msgs --no-default-features --features sensor_msgs
          cargo build -p ros-z-msgs --no-default-features --features nav_msgs

  with-ros:
    name: ROS-dependent Test (${{ matrix.distro }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        distro: [humble, jazzy]
        # distro: [humble, jazzy, rolling]  # Uncomment to test rolling when stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        if: matrix.distro == 'humble'
        with:
          # Free up space by removing large packages
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://ros.cachix.org
            extra-trusted-public-keys = ros.cachix.org-1:dSyZxI8geDCJrwgvCOHDoAfOm5sV1wCPjBkKL+38Rvo=

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ros
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#ros-${{ matrix.distro }}-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=1G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Check available disk space
        run: |
          df -h
          echo "Available space in /home/runner:"
          du -sh /home/runner/* 2>/dev/null | sort -h || true

      - name: Clippy (workspace without rcl-z, without examples)
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy --workspace --exclude rcl-z --lib --bins --tests --no-default-features \
              --features humble -- -D warnings
          else
            cargo clippy --workspace --exclude rcl-z --lib --bins --tests -- -D warnings
          fi

      - name: Clippy bundled examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy -p ros-z --examples --no-default-features --features humble -- -D warnings
          else
            cargo clippy -p ros-z --examples -- -D warnings
          fi

      - name: Clippy external_msgs examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy -p ros-z --examples --no-default-features --features external_msgs,humble -- -D warnings
          else
            cargo clippy -p ros-z --examples --features external_msgs -- -D warnings
          fi

      - name: Clippy rcl-z with distro-specific features
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Humble: lib only (tests use APIs not available in Humble)
            cargo clippy -p rcl-z --lib --features humble_compat -- -D warnings
          else
            # Jazzy+: all targets including tests
            cargo clippy -p rcl-z --all-targets -- -D warnings
          fi

      - name: Clean clippy artifacts to save space
        run: |
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # For Humble, do aggressive cleanup
            cargo clean --release
            cargo clean --doc
            rm -rf target/debug/incremental
            rm -rf target/debug/.fingerprint
            # Show what we freed
            df -h
          fi

      - name: Check rcl-z
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p rcl-z --features humble_compat
          else
            cargo check -p rcl-z
          fi

      - name: Check ros-z-msgs with all messages
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Just check all_msgs (includes bundled + external)
            cargo check -p ros-z-msgs --no-default-features --features all_msgs,humble
          else
            # Just check all_msgs (includes bundled + external)
            cargo check -p ros-z-msgs --features all_msgs
          fi

      - name: Check with protobuf feature
        run: |
          source /tmp/nix-dev-env.sh
          # Skip protobuf check for Humble to save disk space
          if [ "${{ matrix.distro }}" != "humble" ]; then
            cargo check -p ros-z -p ros-z-msgs --features ros-z/protobuf,ros-z-msgs/protobuf
          fi

      - name: Check ros-z (with rcl-z feature)
        run: |
          source /tmp/nix-dev-env.sh
          # Skip rcl-z check to save disk space (tested in dedicated step)
          # if [ "${{ matrix.distro }}" = "humble" ]; then
          #   cargo check -p ros-z --no-default-features --features rcl-z,humble
          # else
          #   cargo check -p ros-z --features rcl-z
          # fi

      - name: Build examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Build with external_msgs (includes bundled messages too)
            cargo build --examples --no-default-features --features external_msgs,humble
          else
            # Build with external_msgs (includes bundled messages too)
            cargo build --examples --features external_msgs
          fi

      - name: Clean build artifacts to save space
        run: |
          # Aggressive cleanup - we only need the examples we just built
          # Remove all dependencies except the final executables
          find target/debug/deps -type f ! -name "*.so" -delete 2>/dev/null || true
          rm -rf target/debug/.fingerprint
          rm -rf target/debug/incremental
          rm -rf target/debug/build
          # Clean up Nix store to free space
          nix-collect-garbage -d || true
          # Show disk usage
          df -h
          echo "Target directory size:"
          du -sh target/ 2>/dev/null || true

      - name: Build protobuf demo
        run: |
          source /tmp/nix-dev-env.sh
          # Skip protobuf demo for Humble to save disk space
          if [ "${{ matrix.distro }}" != "humble" ]; then
            cargo build -p protobuf_demo
          fi

      - name: Free up disk space before tests
        run: |
          # Remove unnecessary system files
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af || true
          # Clean cargo cache
          rm -rf ~/.cargo/registry/index
          rm -rf ~/.cargo/registry/cache
          rm -rf ~/.cargo/git/db
          # Final cleanup
          nix-collect-garbage -d || true
          df -h

      - name: Run unit tests
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Exclude rcl-z for Humble due to missing type hash/description interfaces
            cargo nextest run --workspace --exclude rcl-z --no-default-features --features humble
          else
            # Run all tests for Jazzy and newer distros
            cargo nextest run --workspace
          fi
