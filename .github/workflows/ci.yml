name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  formatting:
    name: Check Formatting
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Check formatting
        run: nix build .#checks.x86_64-linux.pre-commit-check -L

  no-ros:
    name: ROS-independent Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#pureRust-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Clippy (default workspace)
        run: |
          source /tmp/nix-dev-env.sh
          cargo clippy --lib --bins --tests -- -D warnings

      - name: Check default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo check

      - name: Build default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo build

      - name: Build examples without ROS dependencies
        run: |
          source /tmp/nix-dev-env.sh
          cargo build --examples

      - name: Run tests
        run: |
          source /tmp/nix-dev-env.sh
          cargo nextest run

      - name: Check ros-z-msgs with bundled messages (no ROS required)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs
          cargo check -p ros-z-msgs --features bundled_msgs
          cargo check -p ros-z-msgs --features common_interfaces

      - name: Build ros-z-msgs with individual bundled packages
        run: |
          source /tmp/nix-dev-env.sh
          cargo build -p ros-z-msgs --no-default-features --features std_msgs
          cargo build -p ros-z-msgs --no-default-features --features geometry_msgs
          cargo build -p ros-z-msgs --no-default-features --features sensor_msgs
          cargo build -p ros-z-msgs --no-default-features --features nav_msgs

  with-ros:
    name: ROS-dependent Test (${{ matrix.distro }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        distro: [humble, jazzy]
        # distro: [humble, jazzy, rolling]  # Uncomment to test rolling when stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://ros.cachix.org
            extra-trusted-public-keys = ros.cachix.org-1:dSyZxI8geDCJrwgvCOHDoAfOm5sV1wCPjBkKL+38Rvo=

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ros
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#ros-${{ matrix.distro }}-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Clippy (workspace without rcl-z, without examples)
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy --workspace --exclude rcl-z --lib --bins --tests --no-default-features \
              --features humble -- -D warnings
          else
            cargo clippy --workspace --exclude rcl-z --lib --bins --tests -- -D warnings
          fi

      - name: Clippy bundled examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy -p ros-z --examples --no-default-features --features humble -- -D warnings
          else
            cargo clippy -p ros-z --examples -- -D warnings
          fi

      - name: Clippy external_msgs examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo clippy -p ros-z --examples --no-default-features --features external_msgs,humble -- -D warnings
          else
            cargo clippy -p ros-z --examples --features external_msgs -- -D warnings
          fi

      - name: Clippy rcl-z with distro-specific features
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Humble: lib only (tests use APIs not available in Humble)
            cargo clippy -p rcl-z --lib --features humble_compat -- -D warnings
          else
            # Jazzy+: all targets including tests
            cargo clippy -p rcl-z --all-targets -- -D warnings
          fi

      - name: Check rcl-z
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p rcl-z --features humble_compat
          else
            cargo check -p rcl-z
          fi

      - name: Check ros-z-msgs (default bundled features)
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p ros-z-msgs --no-default-features --features bundled_msgs,humble
          else
            cargo check -p ros-z-msgs
          fi

      - name: Check ros-z-msgs with external messages
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p ros-z-msgs --no-default-features --features external_msgs,humble
            cargo check -p ros-z-msgs --no-default-features --features example_interfaces,humble
          else
            cargo check -p ros-z-msgs --features external_msgs
            cargo check -p ros-z-msgs --features example_interfaces
          fi

      - name: Check ros-z-msgs with all messages (bundled + external)
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p ros-z-msgs --no-default-features --features all_msgs,humble
          else
            cargo check -p ros-z-msgs --features all_msgs
          fi

      - name: Check with protobuf feature
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p ros-z -p ros-z-msgs --no-default-features \
              --features ros-z/protobuf,ros-z-msgs/protobuf,ros-z/humble,ros-z-msgs/humble
          else
            cargo check -p ros-z -p ros-z-msgs --features ros-z/protobuf,ros-z-msgs/protobuf
          fi

      - name: Check ros-z (with rcl-z feature)
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo check -p ros-z --no-default-features --features rcl-z,humble
          else
            cargo check -p ros-z --features rcl-z
          fi

      - name: Build examples
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Build bundled message examples (those without required-features)
            cargo build --examples --no-default-features --features humble
            # Build external message examples (those with required-features = ["external_msgs"])
            cargo build --examples --no-default-features --features external_msgs,humble
          else
            # Build bundled message examples (those without required-features)
            cargo build --examples
            # Build external message examples (those with required-features = ["external_msgs"])
            cargo build --examples --features external_msgs
          fi

      - name: Build protobuf demo
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo build -p protobuf_demo --no-default-features --features humble
          else
            cargo build -p protobuf_demo
          fi

      - name: Run unit tests
        run: |
          source /tmp/nix-dev-env.sh
          if [ "${{ matrix.distro }}" = "humble" ]; then
            # Exclude rcl-z for Humble due to missing type hash/description interfaces
            cargo nextest run --workspace --exclude rcl-z --no-default-features --features humble
          else
            # Run all tests for Jazzy and newer distros
            cargo nextest run --workspace
          fi
