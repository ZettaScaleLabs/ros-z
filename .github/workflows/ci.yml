name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  formatting:
    name: Check Formatting
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: FlakeHub / Magic cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Check formatting
        run: nix build .#checks.x86_64-linux.pre-commit-check -L

  no-ros:
    name: ROS-independent Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: FlakeHub / Magic cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache nix dev environment
        id: cache-nix-env
        uses: actions/cache@v4
        with:
          path: /tmp/nix-dev-env.sh
          key: nix-env-pureRust-ci-${{ hashFiles('flake.lock', 'flake.nix') }}

      - name: Setup nix environment
        if: steps.cache-nix-env.outputs.cache-hit != 'true'
        run: nix print-dev-env '.#pureRust-ci' --accept-flake-config > /tmp/nix-dev-env.sh

      - name: Configure sccache
        run: |
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Clippy (default workspace)
        run: |
          source /tmp/nix-dev-env.sh
          cargo clippy --lib --bins --tests -- -D warnings

      - name: Check default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo check

      - name: Build default workspace
        run: |
          source /tmp/nix-dev-env.sh
          cargo build

      - name: Build examples without ROS dependencies
        run: |
          source /tmp/nix-dev-env.sh
          cargo build --examples

      - name: Run tests
        run: |
          source /tmp/nix-dev-env.sh
          cargo nextest run

      - name: Check ros-z-msgs with bundled messages (no ROS required)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs
          cargo check -p ros-z-msgs --features bundled_msgs
          cargo check -p ros-z-msgs --features common_interfaces

      - name: Build ros-z-msgs with individual bundled packages
        run: |
          source /tmp/nix-dev-env.sh
          cargo build -p ros-z-msgs --no-default-features --features std_msgs
          cargo build -p ros-z-msgs --no-default-features --features geometry_msgs
          cargo build -p ros-z-msgs --no-default-features --features sensor_msgs
          cargo build -p ros-z-msgs --no-default-features --features nav_msgs

  with-ros:
    name: ROS-dependent Test (${{ matrix.distro }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        distro: [jazzy]
        # distro: [jazzy, rolling]  # Uncomment to test rolling when stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://ros.cachix.org
            extra-trusted-public-keys = ros.cachix.org-1:dSyZxI8geDCJrwgvCOHDoAfOm5sV1wCPjBkKL+38Rvo=

      - name: FlakeHub / Magic cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ros
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache nix dev environment
        id: cache-nix-env
        uses: actions/cache@v4
        with:
          path: /tmp/nix-dev-env.sh
          key: nix-env-ros-${{ matrix.distro }}-ci-${{ hashFiles('flake.lock', 'flake.nix') }}

      - name: Setup nix environment
        if: steps.cache-nix-env.outputs.cache-hit != 'true'
        run: nix print-dev-env '.#ros-${{ matrix.distro }}-ci' --accept-flake-config > /tmp/nix-dev-env.sh

      - name: Configure sccache
        run: |
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh

      - name: Clippy (all targets, all features)
        run: |
          source /tmp/nix-dev-env.sh
          cargo clippy --all-targets --all-features --workspace -- -D warnings

      - name: Check rcl-z
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p rcl-z

      - name: Check ros-z-msgs (default bundled features)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs

      - name: Check ros-z-msgs with external messages
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs --features external_msgs
          cargo check -p ros-z-msgs --features example_interfaces

      - name: Check ros-z-msgs with all messages (bundled + external)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z-msgs --features all_msgs

      - name: Check with protobuf feature
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z -p ros-z-msgs --features ros-z/protobuf,ros-z-msgs/protobuf

      - name: Check ros-z (with rcl-z feature)
        run: |
          source /tmp/nix-dev-env.sh
          cargo check -p ros-z --features rcl-z

      - name: Build ROS message examples
        run: |
          source /tmp/nix-dev-env.sh
          cargo build -p ros-z-msgs
          cargo build --examples
          cargo build --example z_srvcli --features external_msgs

      - name: Build protobuf demo
        run: |
          source /tmp/nix-dev-env.sh
          cargo build -p protobuf_demo

      # FIXME: This requires the installation of rmw_zenoh_cpp triggering a build from source...
      # - name: Run unit tests
      #   run: |
      #     nix develop .#ci -c cargo test --all-features
