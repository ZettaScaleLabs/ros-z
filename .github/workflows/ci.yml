name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  formatting:
    name: Check Formatting
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Check formatting
        run: nix build .#checks.x86_64-linux.pre-commit-check -L

  no-ros:
    name: ROS-independent Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Install Nushell
        run: |
          nix profile install nixpkgs#nushell
          chmod +x scripts/test-pure-rust.nu

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#pureRust-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=2G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh
          echo "export CI=true" >> /tmp/nix-dev-env.sh

      - name: Clippy (default workspace)
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-pure-rust.nu clippy-workspace

      - name: Build examples
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-pure-rust.nu build-examples

      - name: Run tests
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-pure-rust.nu run-tests

      - name: Check ros-z-msgs feature flags
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-pure-rust.nu check-bundled-msgs

  with-ros:
    name: rcl-z Test (${{ matrix.distro }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        distro: [humble, jazzy]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Determinate Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://ros.cachix.org
            extra-trusted-public-keys = ros.cachix.org-1:dSyZxI8geDCJrwgvCOHDoAfOm5sV1wCPjBkKL+38Rvo=

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ros
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Install Nushell
        run: |
          nix profile install nixpkgs#nushell
          chmod +x scripts/test-ros.nu

      - name: Setup nix environment
        run: |
          nix print-dev-env '.#ros-${{ matrix.distro }}-ci' --accept-flake-config > /tmp/nix-dev-env.sh
          echo "export SCCACHE_GHA_ENABLED=true" >> /tmp/nix-dev-env.sh
          echo "export SCCACHE_CACHE_SIZE=1G" >> /tmp/nix-dev-env.sh
          echo "export RUSTC_WRAPPER=sccache" >> /tmp/nix-dev-env.sh
          echo "export CI=true" >> /tmp/nix-dev-env.sh

      - name: Clippy rcl-z
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-ros.nu ${{ matrix.distro }} clippy-rclz

      - name: Build rcl-z
        run: |
          source /tmp/nix-dev-env.sh
          nu scripts/test-ros.nu ${{ matrix.distro }} build-rclz
