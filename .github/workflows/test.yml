name: Interop Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  interop_test:
    name: Interop tests with ROS 2 Jazzy
    runs-on: ubuntu-latest
    container:
      image: rostooling/setup-ros-docker:ubuntu-noble-ros-jazzy-ros-base-latest
    steps:
      - name: Install system dependencies
        run: apt-get update && apt-get install -y nodejs

      - name: Install ROS dependencies
        run: |
          apt-get install -y \
            ros-jazzy-example-interfaces \
            ros-jazzy-rmw-zenoh-cpp \
            ros-jazzy-demo-nodes-cpp \
            ros-jazzy-action-tutorials-cpp \
            protobuf-compiler

      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run interop tests
        shell: bash
        run: |
          source /opt/ros/jazzy/setup.bash
          export RMW_IMPLEMENTATION=rmw_zenoh_cpp
          cargo nextest run -p ros-z-tests --features interop-tests --release
