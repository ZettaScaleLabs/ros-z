name: Interop Tests

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'book/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mdbook-preview.yml'
      - '.github/workflows/ci.yml'
      - '.github/workflows/rmw-zenoh-rs.yml'
      - '.github/workflows/semantic-pr.yml'
      - '.github/workflows/pr-draft-check.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'book/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mdbook-preview.yml'
      - '.github/workflows/ci.yml'
      - '.github/workflows/rmw-zenoh-rs.yml'
      - '.github/workflows/semantic-pr.yml'
      - '.github/workflows/pr-draft-check.yml'

jobs:
  interop_test:
    name: Interop tests with ROS 2 ${{ matrix.distro }}
    runs-on: ubuntu-latest
    # Skip for draft PRs to save CI time during development
    if: |
      github.event_name == 'push' ||
      github.event.pull_request.draft == false
    strategy:
      matrix:
        distro: [humble, jazzy, kilted]
        include:
          - distro: humble
            image: rostooling/setup-ros-docker:ubuntu-jammy-ros-humble-ros-base-latest
          - distro: jazzy
            image: rostooling/setup-ros-docker:ubuntu-noble-ros-jazzy-ros-base-latest
          - distro: kilted
            image: ros:kilted-ros-base
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install system dependencies
        run: apt-get update && apt-get install -y nodejs

      - name: Install ROS dependencies
        run: |
          apt-get install -y \
            ros-${{ matrix.distro }}-example-interfaces \
            ros-${{ matrix.distro }}-rmw-zenoh-cpp \
            ros-${{ matrix.distro }}-demo-nodes-cpp \
            ros-${{ matrix.distro }}-action-tutorials-cpp \
            protobuf-compiler

      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run interop tests
        shell: bash
        run: |
          source /opt/ros/${{ matrix.distro }}/setup.bash
          export RMW_IMPLEMENTATION=rmw_zenoh_cpp
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo nextest run -p ros-z-tests --no-default-features --features ros-interop,humble --release
            cargo nextest run -p ros-z-console --no-default-features --features ros-interop,humble --release
          else
            cargo nextest run -p ros-z-tests --features ros-interop,${{ matrix.distro }} --release
            cargo nextest run -p ros-z-console --features ros-interop --release
          fi
