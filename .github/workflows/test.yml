name: Interop Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  interop_test:
    name: Interop tests with ROS 2 ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: [humble, jazzy]
        include:
          - distro: humble
            image: rostooling/setup-ros-docker:ubuntu-jammy-ros-humble-ros-base-latest
          - distro: jazzy
            image: rostooling/setup-ros-docker:ubuntu-noble-ros-jazzy-ros-base-latest
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install system dependencies
        run: apt-get update && apt-get install -y nodejs

      - name: Install ROS dependencies
        run: |
          apt-get install -y \
            ros-${{ matrix.distro }}-example-interfaces \
            ros-${{ matrix.distro }}-rmw-zenoh-cpp \
            ros-${{ matrix.distro }}-demo-nodes-cpp \
            ros-${{ matrix.distro }}-action-tutorials-cpp \
            protobuf-compiler

      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run interop tests
        shell: bash
        run: |
          source /opt/ros/${{ matrix.distro }}/setup.bash
          export RMW_IMPLEMENTATION=rmw_zenoh_cpp
          if [ "${{ matrix.distro }}" = "humble" ]; then
            cargo nextest run -p ros-z-tests --no-default-features --features ros-interop,humble --release
          else
            cargo nextest run -p ros-z-tests --features ros-interop,${{ matrix.distro }} --release
          fi
